name: Release

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Auto increment version
        id: version
        run: |
          # í˜„ì¬ ë²„ì „ ê°€ì ¸ì˜¤ê¸°
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          echo "previous_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # ë²„ì „ì„ 0.0.1 ì¦ê°€
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          NEW_PATCH=$((patch + 1))
          NEW_VERSION="$major.$minor.$NEW_PATCH"

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # package.json ì—…ë°ì´íŠ¸
          npm version $NEW_VERSION --no-git-tag-version

      - name: Build application
        run: npm run build

      - name: Build release packages
        run: npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate changelog
        id: changelog
        run: |
          # ì´ì „ íƒœê·¸ ì°¾ê¸°
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, using all commits"
            COMMITS=$(git log --pretty=format:"- %s" --no-merges)
          else
            echo "Previous tag: $PREV_TAG"
            echo "Current HEAD: $(git rev-parse HEAD)"
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges)
            echo "Found $(echo "$COMMITS" | wc -l) commits"
          fi

          echo "All commits:"
          echo "$COMMITS"

          # ë³€ê²½ì‚¬í•­ì„ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë¶„ë¥˜
          FEATURES=$(echo "$COMMITS" | grep -iE "^- (feat|feature)" || true)
          FIXES=$(echo "$COMMITS" | grep -i "^- fix" || true)
          REFACTORS=$(echo "$COMMITS" | grep -i "^- refactor" || true)
          DOCS=$(echo "$COMMITS" | grep -i "^- docs" || true)
          CHORES=$(echo "$COMMITS" | grep -iE "^- (chore|build|ci)" || true)
          OTHERS=$(echo "$COMMITS" | grep -ivE "^- (feat|feature|fix|refactor|docs|chore|build|ci)" || true)

          # ë³€ê²½ì‚¬í•­ ìƒì„±
          CHANGELOG=""

          if [ -n "$FEATURES" ]; then
            CHANGELOG="${CHANGELOG}### âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥\n${FEATURES}\n\n"
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ› ë²„ê·¸ ìˆ˜ì •\n${FIXES}\n\n"
          fi

          if [ -n "$REFACTORS" ]; then
            CHANGELOG="${CHANGELOG}### â™»ï¸ ë¦¬íŒ©í† ë§\n${REFACTORS}\n\n"
          fi

          if [ -n "$DOCS" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ“ ë¬¸ì„œ\n${DOCS}\n\n"
          fi

          if [ -n "$CHORES" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ”§ ë¹Œë“œ/ê¸°íƒ€\n${CHORES}\n\n"
          fi

          if [ -n "$OTHERS" ]; then
            CHANGELOG="${CHANGELOG}### ê¸°íƒ€ ë³€ê²½ì‚¬í•­\n${OTHERS}\n\n"
          fi

          # ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì „ì²´ ì»¤ë°‹ í‘œì‹œ
          if [ -z "$CHANGELOG" ]; then
            if [ -n "$COMMITS" ]; then
              CHANGELOG="### ë³€ê²½ì‚¬í•­\n${COMMITS}\n"
            else
              CHANGELOG="- ë‚´ë¶€ ê°œì„  ë° ë²„ê·¸ ìˆ˜ì •"
            fi
          fi

          # GitHub Outputìœ¼ë¡œ ì „ë‹¬ (ë©€í‹°ë¼ì¸ ì²˜ë¦¬)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            release/Key-ti-${{ steps.version.outputs.version }}-distribution.zip
            release/latest-mac.yml
          body: |
            ## ğŸš€ Key-ti v${{ steps.version.outputs.version }}

            ${{ steps.changelog.outputs.changelog }}

            ---

            ### ğŸ“¦ ì„¤ì¹˜ ë°©ë²•
            1. `Key-ti-${{ steps.version.outputs.version }}-distribution.zip` ë‹¤ìš´ë¡œë“œ
            2. ì••ì¶• í•´ì œ
            3. í„°ë¯¸ë„ì—ì„œ `./install.sh` ì‹¤í–‰

            ### ğŸ”„ ì—…ë°ì´íŠ¸
            ê¸°ì¡´ ì‚¬ìš©ìëŠ” ì•± ì‹¤í–‰ ì‹œ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ì•Œë¦¼ì„ ë°›ìŠµë‹ˆë‹¤.

            ---

            ğŸ“ **ì „ì²´ ë³€ê²½ì‚¬í•­**: https://github.com/kiduko/key-ti/compare/v${{ steps.version.outputs.previous_version }}...v${{ steps.version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit version change
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add package.json package-lock.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push
